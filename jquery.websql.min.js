/* WebSQL (v0.1) Paul Sayre */
(function(l){var h=l.WebSQL=function(q,s,t,u,v){var r=l.openDatabase&&l.openDatabase(q,s||"1.0",t||q,u||5E6,v),m=r&&{query:function(e){var g=h.Deferred(),i=p(e)?e:arguments;m.rawTx(function(n){var f=h.Deferred(),c,a,d,b,o,j,e,k=f.reject;b=0;for(o=i.length;b<o;b++)if(c=i[b],a=i[b+1],"function"===typeof c&&(c=c.toString(),c=c.substr(c.indexOf("/*!")+3),c=c.substr(0,c.lastIndexOf("*/"))),(d=/^\s*INSERT\s+INTO\s+\w+\s*\(([^\)]+)\)\s*$/i.exec(c))&&d[1]&&(c+=" VALUES ("+Array(d[1].split(",").length).join("?,")+
"?)"),p(a))if(b+=1,p(a[0])){d=0;for(j=a.length;d<j;d++)b+1===o&&d+1===j&&(e=f.resolve),n.executeSql(c,a[d],e,k)}else b+1===o&&(e=f.resolve),n.executeSql(c,a,e,k);else b+1===o&&(e=f.resolve),n.executeSql(c,[],e,k);f.fail(g.reject).done(function(c,a){var b=null,d,f;if(a){if(f=a.rows){b=[];for(d=0;d<f.length;d++)b[d]=f.item(d)}if(b&&0===b.length)try{b.insertId=a.insertId}catch(e){b.insertId=null}else b.insertId=null}g.resolve(b)})});return g.promise()},rawTx:function(e){r.transaction(e)},getTableNames:function(){var e=
$.Deferred();m.query('SELECT tbl_name FROM sqlite_master WHERE type = "table" AND tbl_name NOT REGEXP "^(__|sqlite_).*"').fail(e.reject).done(function(g){var i,n=[];for(i=0;i<g.length;i++)n[i]=g[i].tbl_name;e.resolve(n)});return e.promise()},dump:function(e,g){var i=h.Deferred(),g=!1!==g;switch(e){default:m.query('SELECT * FROM sqlite_master WHERE tbl_name NOT REGEXP "^(__|sqlite_).*" ORDER BY CASE type WHEN "table" THEN 1 WHEN "index" THEN 2 ELSE 3 END').fail(i.reject).done(function(e){var f={},
c=[],a,d;for(d=0;a=e[d];d++)if(a.sql)switch(a.type){case "table":f[a.tbl_name]={schema:{table:a.sql,indexes:[]}};g&&function(b){var a=h.Deferred();m.query("SELECT * FROM "+b).fail(a.reject).done(function(c){delete c.insertId;f[b].data=c;a.resolve()});c.push(a)}(a.tbl_name);break;case "index":f[a.tbl_name].schema.indexes.push(a.sql)}h.when.apply(h,c).fail(i.reject).done(function(){i.resolve(f)})});break;case "sql":m.dump("json",g).fail(i.reject).done(function(e){var f=[],c,a,d,b,g,j,h,k;for(k in e)if(Object.prototype.hasOwnProperty.call(e,
k)&&(c=e[k],f.push(c.schema.table),f=f.concat(c.schema.indexes),c.data&&0<c.data.length)){g=[];a=c.data[0];for(b in a)Object.prototype.hasOwnProperty.call(a,b)&&g.push(/\s/.test(b)?"`"+b+"`":b);g=g.join(", ");j=[];for(d=0;a=c.data[d];d++){j[d]=[];for(b in a)Object.prototype.hasOwnProperty.call(a,b)&&(h="number"===typeof a[b]?a[b]:null===a[b]||void 0===a[b]?"NULL":'"'+a[b]+'"',j[d].push(h));j[d]="("+j[d].join(", ")+")"}j=j.join(",\n\t");f.push("INSERT INTO "+k+" ("+g+") VALUES\n\t"+j)}f=f.join(";\n")+
";";i.resolve(f)})}return i.promise()}};return m},p=Array.isArray||function(h){return!!(h&&h.constructor===Array)}})(window);(function(l,h){h.when=l.when;h.Deferred=l.Deferred;l.WebSQL=h})(jQuery,WebSQL);
