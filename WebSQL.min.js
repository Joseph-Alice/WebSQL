/* WebSQL (v0.1) Paul Sayre */
(function(g){var k=g.WebSQL=function(e,d,b,a,c){var i=g.openDatabase&&g.openDatabase(e,d||"1.0",b||e,a||5E6,c),o=i&&{query:function(b){var e=k.Deferred(),a=f(b)?b:arguments;o.rawTx(function(b){var d=k.Deferred(),c,g,h,l,m,i,j,n=d.reject;h=0;for(l=a.length;h<l;h++)if(c=a[h],g=a[h+1],"function"===typeof c&&(c=c.toString(),c=c.substr(c.indexOf("/*!")+3),c=c.substr(0,c.lastIndexOf("*/"))),f(g))if(h+=1,f(g[0])){m=0;for(i=g.length;m<i;m++)h+1===l&&m+1===i&&(j=d.resolve),b.executeSql(c,g[m],j,n)}else h+
1===l&&(j=d.resolve),b.executeSql(c,g,j,n);else h+1===l&&(j=d.resolve),b.executeSql(c,[],j,n);d.fail(e.reject).done(function(b,c){var a=null,d,f;if(c){if(f=c.rows){a=[];for(d=0;d<f.length;d++)a[d]=f.item(d)}if(a&&0===a.length)try{a.insertId=c.insertId}catch(g){a.insertId=null}else a.insertId=null}e.resolve(a)})});return e.promise()},rawTx:function(a){i.transaction(a)}};return o},f=Array.isArray||function(e){return!!(e&&e.constructor===Array)}})(window);
(function(g){g.Deferred=function(){var f,e=k(),d=k(),b={promise:function(){var a={},c=function(b){return function(){b.apply(this,arguments);return a}};a.always=c(b.always);a.done=c(b.done);a.fail=c(b.fail);a.then=c(b.then);a.state=b.state;return a},state:function(){return f||"pending"},resolve:function(){f||(f="resolved",e.fire.apply(e,arguments));return b},reject:function(){f||(f="rejected",d.fire.apply(d,arguments));return b},always:function(a){return b.then(a,a)},done:function(a){e.add(a);return b},
fail:function(a){d.add(a);return b},then:function(a,c){return b.done(a).fail(c)}};return b};g.when=function(f){var e,d=Array(arguments.length),b=g.Deferred();for(e=0;e<arguments.length;e++)arguments[e].fail(function(){b.reject.apply(this,arguments);d=null});for(e=0;e<arguments.length;e++)(function(a){arguments[a].done(function(){d[a]=arguments;for(var c=0;c<d.length&&void 0!==d[c];c++);c===d.length&&b.resolve.apply(b,d)})})(e);return b.promise()};var k=function(){var f=[],e,d={hasFired:function(){return!!e},
add:function(b){f.push(b);d.hasFired()&&d.fire.apply(d,e)},fire:function(){e=arguments;for(var b=0;b<f.length;b++)f[b].apply(d,e);f=[]}};return d}})(WebSQL);
